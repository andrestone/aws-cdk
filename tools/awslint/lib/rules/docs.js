"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const linter_1 = require("../linter");
const core_types_1 = require("./core-types");
exports.docsLinter = new linter_1.Linter(assembly => {
    return [
        ...flatMap(assembly.classes, classType => [
            { assembly, kind: 'type', documentable: classType, errorKey: classType.fqn },
            ...classType.ownProperties.map(property => ({ assembly, kind: 'class-property', containingType: classType, documentable: property, errorKey: `${classType.fqn}.${property.name}` })),
            ...classType.ownMethods.map(method => ({ assembly, kind: 'method', containingType: classType, documentable: method, errorKey: `${classType.fqn}.${method.name}` })),
        ]),
        ...flatMap(assembly.interfaces, interfaceType => [
            { assembly, kind: 'type', documentable: interfaceType, errorKey: interfaceType.fqn },
            // tslint:disable-next-line:max-line-length
            ...interfaceType.ownProperties.map(property => ({ assembly, kind: 'interface-property', containingType: interfaceType, documentable: property, errorKey: `${interfaceType.fqn}.${property.name}` })),
            ...interfaceType.ownMethods.map(method => ({ assembly, kind: 'method', containingType: interfaceType, documentable: method, errorKey: `${interfaceType.fqn}.${method.name}` })),
        ]),
        ...flatMap(assembly.enums, enumType => [
            { assembly, kind: 'type', documentable: enumType, errorKey: enumType.fqn },
            ...enumType.members.map(member => ({ assembly, kind: 'enum-member', containingType: enumType, documentable: member, errorKey: `${enumType.fqn}.${member.name}` }))
        ]),
    ];
});
exports.docsLinter.add({
    code: 'docs-public-apis',
    message: 'Public API element must have a docstring',
    eval: e => {
        if (!isPublic(e.ctx)) {
            return;
        }
        // this rule does not apply to L1 constructs
        if (isCfnType(e.ctx)) {
            return;
        }
        if (!e.ctx.documentable.docs.summary) {
            e.assert(e.ctx.documentable.docs.summary, e.ctx.errorKey);
        }
    }
});
exports.docsLinter.add({
    code: 'props-default-doc',
    message: 'Optional property must have @default documentation',
    eval: e => {
        if (e.ctx.kind !== 'interface-property') {
            return;
        }
        if (!e.ctx.containingType.isDataType()) {
            return;
        }
        // this rule does not apply to L1 constructs
        if (core_types_1.CoreTypes.isCfnType(e.ctx.containingType)) {
            return;
        }
        const property = e.ctx.documentable;
        e.assert(!property.optional || property.docs.docs.default !== undefined, e.ctx.errorKey);
    }
});
exports.docsLinter.add({
    code: 'props-no-undefined-default',
    message: `'@default undefined' is not helpful. Users will know the VALUE is literally 'undefined' if they don't specify it, but what is the BEHAVIOR if they do so?`,
    eval: e => {
        if (e.ctx.kind !== 'interface-property') {
            return;
        }
        if (!e.ctx.containingType.isDataType()) {
            return;
        }
        const property = e.ctx.documentable;
        e.assert(property.docs.docs.default !== 'undefined', e.ctx.errorKey);
    }
});
function isPublic(ctx) {
    switch (ctx.kind) {
        case "class-property":
        case "interface-property":
        case "method":
            return !ctx.documentable.protected;
        case "enum-member":
        case "type":
            return true;
    }
}
function isCfnType(ctx) {
    switch (ctx.kind) {
        case "class-property":
        case "interface-property":
        case "method":
        case "enum-member":
            return core_types_1.CoreTypes.isCfnType(ctx.containingType);
        case "type":
            return core_types_1.CoreTypes.isCfnType(ctx.documentable);
    }
}
function flatMap(array, callbackfn) {
    return Array.prototype.concat(...array.map(callbackfn));
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZG9jcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImRvY3MudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFDQSxzQ0FBbUM7QUFDbkMsNkNBQXlDO0FBWTVCLFFBQUEsVUFBVSxHQUFHLElBQUksZUFBTSxDQUFvQixRQUFRLENBQUMsRUFBRTtJQUNqRSxPQUFPO1FBQ0wsR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLE9BQU8sRUFBRSxTQUFTLENBQUMsRUFBRSxDQUFDO1lBQ3hDLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsWUFBWSxFQUFFLFNBQVMsRUFBRSxRQUFRLEVBQUUsU0FBUyxDQUFDLEdBQUcsRUFBRTtZQUM1RSxHQUFHLFNBQVMsQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsZ0JBQWdCLEVBQUUsY0FBYyxFQUFFLFNBQVMsRUFBRSxZQUFZLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxHQUFHLFNBQVMsQ0FBQyxHQUFHLElBQUksUUFBUSxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQztZQUNwTCxHQUFHLFNBQVMsQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLGNBQWMsRUFBRSxTQUFTLEVBQUUsWUFBWSxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsR0FBRyxTQUFTLENBQUMsR0FBRyxJQUFJLE1BQU0sQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUM7U0FDcEssQ0FBQztRQUNGLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxVQUFVLEVBQUUsYUFBYSxDQUFDLEVBQUUsQ0FBQztZQUMvQyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLFlBQVksRUFBRSxhQUFhLEVBQUUsUUFBUSxFQUFFLGFB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QUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUMsQ0FBQztRQUVqRCxLQUFLLE1BQU07WUFDVCxPQUFPLHNCQUFTLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsQ0FBQztLQUNoRDtBQUNILENBQUM7QUFFRCxTQUFTLE9BQU8sQ0FBTyxLQUFtQixFQUFFLFVBQWlFO0lBQzNHLE9BQU8sS0FBSyxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUM7QUFDMUQsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIHJlZmxlY3QgZnJvbSAnanNpaS1yZWZsZWN0JztcbmltcG9ydCB7IExpbnRlciB9IGZyb20gJy4uL2xpbnRlcic7XG5pbXBvcnQgeyBDb3JlVHlwZXMgfSBmcm9tICcuL2NvcmUtdHlwZXMnO1xuXG50eXBlIERvY3NMaW50ZXJDb250ZXh0ID0ge1xuICByZWFkb25seSBhc3NlbWJseTogcmVmbGVjdC5Bc3NlbWJseTtcbiAgcmVhZG9ubHkgZXJyb3JLZXk6IHN0cmluZztcbn0gJiAoeyByZWFkb25seSBraW5kOiAndHlwZSc7IGRvY3VtZW50YWJsZTogcmVmbGVjdC5UeXBlIH1cbiAgfCB7IHJlYWRvbmx5IGtpbmQ6ICdpbnRlcmZhY2UtcHJvcGVydHknOyBjb250YWluaW5nVHlwZTogcmVmbGVjdC5JbnRlcmZhY2VUeXBlOyBkb2N1bWVudGFibGU6IHJlZmxlY3QuUHJvcGVydHkgfVxuICB8IHsgcmVhZG9ubHkga2luZDogJ2NsYXNzLXByb3BlcnR5JzsgY29udGFpbmluZ1R5cGU6IHJlZmxlY3QuQ2xhc3NUeXBlOyBkb2N1bWVudGFibGU6IHJlZmxlY3QuUHJvcGVydHkgfVxuICB8IHsgcmVhZG9ubHkga2luZDogJ21ldGhvZCc7IGNvbnRhaW5pbmdUeXBlOiByZWZsZWN0LlJlZmVyZW5jZVR5cGU7IGRvY3VtZW50YWJsZTogcmVmbGVjdC5NZXRob2QgfVxuICB8IHsgcmVhZG9ubHkga2luZDogJ2VudW0tbWVtYmVyJzsgY29udGFpbmluZ1R5cGU6IHJlZmxlY3QuRW51bVR5cGU7IGRvY3VtZW50YWJsZTogcmVmbGVjdC5FbnVtTWVtYmVyIH1cbik7XG5cbmV4cG9ydCBjb25zdCBkb2NzTGludGVyID0gbmV3IExpbnRlcjxEb2NzTGludGVyQ29udGV4dD4oYXNzZW1ibHkgPT4ge1xuICByZXR1cm4gW1xuICAgIC4uLmZsYXRNYXAoYXNzZW1ibHkuY2xhc3NlcywgY2xhc3NUeXBlID0+IFtcbiAgICAgIHsgYXNzZW1ibHksIGtpbmQ6ICd0eXBlJywgZG9jdW1lbnRhYmxlOiBjbGFzc1R5cGUsIGVycm9yS2V5OiBjbGFzc1R5cGUuZnFuIH0sXG4gICAgICAuLi5jbGFzc1R5cGUub3duUHJvcGVydGllcy5tYXAocHJvcGVydHkgPT4gKHsgYXNzZW1ibHksIGtpbmQ6ICdjbGFzcy1wcm9wZXJ0eScsIGNvbnRhaW5pbmdUeXBlOiBjbGFzc1R5cGUsIGRvY3VtZW50YWJsZTogcHJvcGVydHksIGVycm9yS2V5OiBgJHtjbGFzc1R5cGUuZnFufS4ke3Byb3BlcnR5Lm5hbWV9YCB9KSksXG4gICAgICAuLi5jbGFzc1R5cGUub3duTWV0aG9kcy5tYXAobWV0aG9kID0+ICh7IGFzc2VtYmx5LCBraW5kOiAnbWV0aG9kJywgY29udGFpbmluZ1R5cGU6IGNsYXNzVHlwZSwgZG9jdW1lbnRhYmxlOiBtZXRob2QsIGVycm9yS2V5OiBgJHtjbGFzc1R5cGUuZnFufS4ke21ldGhvZC5uYW1lfWAgfSkpLFxuICAgIF0pLFxuICAgIC4uLmZsYXRNYXAoYXNzZW1ibHkuaW50ZXJmYWNlcywgaW50ZXJmYWNlVHlwZSA9PiBbXG4gICAgICB7IGFzc2VtYmx5LCBraW5kOiAndHlwZScsIGRvY3VtZW50YWJsZTogaW50ZXJmYWNlVHlwZSwgZXJyb3JLZXk6IGludGVyZmFjZVR5cGUuZnFuIH0sXG4gICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bWF4LWxpbmUtbGVuZ3RoXG4gICAgICAuLi5pbnRlcmZhY2VUeXBlLm93blByb3BlcnRpZXMubWFwKHByb3BlcnR5ID0+ICh7IGFzc2VtYmx5LCBraW5kOiAnaW50ZXJmYWNlLXByb3BlcnR5JywgY29udGFpbmluZ1R5cGU6IGludGVyZmFjZVR5cGUsIGRvY3VtZW50YWJsZTogcHJvcGVydHksIGVycm9yS2V5OiBgJHtpbnRlcmZhY2VUeXBlLmZxbn0uJHtwcm9wZXJ0eS5uYW1lfWAgfSkpLFxuICAgICAgLi4uaW50ZXJmYWNlVHlwZS5vd25NZXRob2RzLm1hcChtZXRob2QgPT4gKHsgYXNzZW1ibHksIGtpbmQ6ICdtZXRob2QnLCBjb250YWluaW5nVHlwZTogaW50ZXJmYWNlVHlwZSwgZG9jdW1lbnRhYmxlOiBtZXRob2QsIGVycm9yS2V5OiBgJHtpbnRlcmZhY2VUeXBlLmZxbn0uJHttZXRob2QubmFtZX1gIH0pKSxcbiAgICBdKSxcbiAgICAuLi5mbGF0TWFwKGFzc2VtYmx5LmVudW1zLCBlbnVtVHlwZSA9PiBbXG4gICAgICB7IGFzc2VtYmx5LCBraW5kOiAndHlwZScsIGRvY3VtZW50YWJsZTogZW51bVR5cGUsIGVycm9yS2V5OiBlbnVtVHlwZS5mcW4gfSxcbiAgICAgIC4uLmVudW1UeXBlLm1lbWJlcnMubWFwKG1lbWJlciA9PiAoeyBhc3NlbWJseSwga2luZDogJ2VudW0tbWVtYmVyJywgY29udGFpbmluZ1R5cGU6IGVudW1UeXBlLCBkb2N1bWVudGFibGU6IG1lbWJlciwgZXJyb3JLZXk6IGAke2VudW1UeXBlLmZxbn0uJHttZW1iZXIubmFtZX1gIH0pKVxuICAgIF0pLFxuICBdIGFzIERvY3NMaW50ZXJDb250ZXh0W107XG59KTtcblxuZG9jc0xpbnRlci5hZGQoe1xuICBjb2RlOiAnZG9jcy1wdWJsaWMtYXBpcycsXG4gIG1lc3NhZ2U6ICdQdWJsaWMgQVBJIGVsZW1lbnQgbXVzdCBoYXZlIGEgZG9jc3RyaW5nJyxcbiAgZXZhbDogZSA9PiB7XG4gICAgaWYgKCFpc1B1YmxpYyhlLmN0eCkpIHsgcmV0dXJuOyB9XG4gICAgLy8gdGhpcyBydWxlIGRvZXMgbm90IGFwcGx5IHRvIEwxIGNvbnN0cnVjdHNcbiAgICBpZiAoaXNDZm5UeXBlKGUuY3R4KSkgeyByZXR1cm47IH1cblxuICAgIGlmICghZS5jdHguZG9jdW1lbnRhYmxlLmRvY3Muc3VtbWFyeSkge1xuICAgICAgZS5hc3NlcnQoZS5jdHguZG9jdW1lbnRhYmxlLmRvY3Muc3VtbWFyeSwgZS5jdHguZXJyb3JLZXkpO1xuICAgIH1cbiAgfVxufSk7XG5cbmRvY3NMaW50ZXIuYWRkKHtcbiAgY29kZTogJ3Byb3BzLWRlZmF1bHQtZG9jJyxcbiAgbWVzc2FnZTogJ09wdGlvbmFsIHByb3BlcnR5IG11c3QgaGF2ZSBAZGVmYXVsdCBkb2N1bWVudGF0aW9uJyxcbiAgZXZhbDogZSA9PiB7XG4gICAgaWYgKGUuY3R4LmtpbmQgIT09ICdpbnRlcmZhY2UtcHJvcGVydHknKSB7IHJldHVybjsgfVxuICAgIGlmICghZS5jdHguY29udGFpbmluZ1R5cGUuaXNEYXRhVHlwZSgpKSB7IHJldHVybjsgfVxuICAgIC8vIHRoaXMgcnVsZSBkb2VzIG5vdCBhcHBseSB0byBMMSBjb25zdHJ1Y3RzXG4gICAgaWYgKENvcmVUeXBlcy5pc0NmblR5cGUoZS5jdHguY29udGFpbmluZ1R5cGUpKSB7IHJldHVybjsgfVxuXG4gICAgY29uc3QgcHJvcGVydHkgPSBlLmN0eC5kb2N1bWVudGFibGU7XG4gICAgZS5hc3NlcnQoIXByb3BlcnR5Lm9wdGlvbmFsIHx8IHByb3BlcnR5LmRvY3MuZG9jcy5kZWZhdWx0ICE9PSB1bmRlZmluZWQsIGUuY3R4LmVycm9yS2V5KTtcbiAgfVxufSk7XG5cbmRvY3NMaW50ZXIuYWRkKHtcbiAgY29kZTogJ3Byb3BzLW5vLXVuZGVmaW5lZC1kZWZhdWx0JyxcbiAgbWVzc2FnZTogYCdAZGVmYXVsdCB1bmRlZmluZWQnIGlzIG5vdCBoZWxwZnVsLiBVc2VycyB3aWxsIGtub3cgdGhlIFZBTFVFIGlzIGxpdGVyYWxseSAndW5kZWZpbmVkJyBpZiB0aGV5IGRvbid0IHNwZWNpZnkgaXQsIGJ1dCB3aGF0IGlzIHRoZSBCRUhBVklPUiBpZiB0aGV5IGRvIHNvP2AsXG4gIGV2YWw6IGUgPT4ge1xuICAgIGlmIChlLmN0eC5raW5kICE9PSAnaW50ZXJmYWNlLXByb3BlcnR5JykgeyByZXR1cm47IH1cbiAgICBpZiAoIWUuY3R4LmNvbnRhaW5pbmdUeXBlLmlzRGF0YVR5cGUoKSkgeyByZXR1cm47IH1cblxuICAgIGNvbnN0IHByb3BlcnR5ID0gZS5jdHguZG9jdW1lbnRhYmxlO1xuICAgIGUuYXNzZXJ0KHByb3BlcnR5LmRvY3MuZG9jcy5kZWZhdWx0ICE9PSAndW5kZWZpbmVkJywgZS5jdHguZXJyb3JLZXkpO1xuICB9XG59KTtcblxuZnVuY3Rpb24gaXNQdWJsaWMoY3R4OiBEb2NzTGludGVyQ29udGV4dCkge1xuICBzd2l0Y2ggKGN0eC5raW5kKSB7XG4gICAgY2FzZSBcImNsYXNzLXByb3BlcnR5XCI6XG4gICAgY2FzZSBcImludGVyZmFjZS1wcm9wZXJ0eVwiOlxuICAgIGNhc2UgXCJtZXRob2RcIjpcbiAgICAgIHJldHVybiAhY3R4LmRvY3VtZW50YWJsZS5wcm90ZWN0ZWQ7XG5cbiAgICBjYXNlIFwiZW51bS1tZW1iZXJcIjpcbiAgICBjYXNlIFwidHlwZVwiOlxuICAgICAgcmV0dXJuIHRydWU7XG4gIH1cbn1cblxuZnVuY3Rpb24gaXNDZm5UeXBlKGN0eDogRG9jc0xpbnRlckNvbnRleHQpIHtcbiAgc3dpdGNoIChjdHgua2luZCkge1xuICAgIGNhc2UgXCJjbGFzcy1wcm9wZXJ0eVwiOlxuICAgIGNhc2UgXCJpbnRlcmZhY2UtcHJvcGVydHlcIjpcbiAgICBjYXNlIFwibWV0aG9kXCI6XG4gICAgY2FzZSBcImVudW0tbWVtYmVyXCI6XG4gICAgICByZXR1cm4gQ29yZVR5cGVzLmlzQ2ZuVHlwZShjdHguY29udGFpbmluZ1R5cGUpO1xuXG4gICAgY2FzZSBcInR5cGVcIjpcbiAgICAgIHJldHVybiBDb3JlVHlwZXMuaXNDZm5UeXBlKGN0eC5kb2N1bWVudGFibGUpO1xuICB9XG59XG5cbmZ1bmN0aW9uIGZsYXRNYXA8VCwgVT4oYXJyYXk6IHJlYWRvbmx5IFRbXSwgY2FsbGJhY2tmbjogKHZhbHVlOiBULCBpbmRleDogbnVtYmVyLCBhcnJheTogcmVhZG9ubHkgVFtdKSA9PiBVW10pOiBVW10ge1xuICByZXR1cm4gQXJyYXkucHJvdG90eXBlLmNvbmNhdCguLi5hcnJheS5tYXAoY2FsbGJhY2tmbikpO1xufVxuIl19