"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const linter_1 = require("../linter");
const core_types_1 = require("./core-types");
exports.constructLinter = new linter_1.Linter(assembly => assembly.classes
    .filter(t => core_types_1.CoreTypes.isConstructClass(t))
    .map(construct => new ConstructReflection(construct)));
class ConstructReflection {
    constructor(classType) {
        this.classType = classType;
        this.fqn = classType.fqn;
        this.sys = classType.system;
        this.core = new core_types_1.CoreTypes(this.sys);
        this.ROOT_CLASS = this.sys.findClass(this.core.constructClass.fqn);
        this.interfaceFqn = `${classType.assembly.name}.I${classType.name}`;
        this.propsFqn = `${classType.assembly.name}.${classType.name}Props`;
        this.interfaceType = this.tryFindInterface();
        this.propsType = this.tryFindProps();
        this.initializer = classType.initializer;
        this.hasPropsArgument = this.initializer != null && this.initializer.parameters.length >= 3;
    }
    static findAllConstructs(assembly) {
        return assembly.classes
            .filter(c => core_types_1.CoreTypes.isConstructClass(c))
            .map(c => new ConstructReflection(c));
    }
    static getFqnFromTypeRef(typeRef) {
        if (typeRef.arrayOfType) {
            return typeRef.arrayOfType.fqn;
        }
        else if (typeRef.mapOfType) {
            return typeRef.mapOfType.fqn;
        }
        return typeRef.fqn;
    }
    tryFindInterface() {
        const sys = this.classType.system;
        const found = sys.tryFindFqn(this.interfaceFqn);
        if (!found) {
            return undefined;
        }
        if (!found.isInterfaceType()) {
            throw new Error(`Expecting type ${this.interfaceFqn} to be an interface`);
        }
        return found;
    }
    tryFindProps() {
        const found = this.sys.tryFindFqn(this.propsFqn);
        if (!found) {
            return undefined;
        }
        if (!found.isInterfaceType()) {
            throw new Error(`Expecting props struct ${this.propsFqn} to be an interface`);
        }
        return found;
    }
}
exports.ConstructReflection = ConstructReflection;
exports.constructLinter.add({
    code: 'construct-ctor',
    message: 'signature of all construct constructors should be "scope, id, props"',
    eval: e => {
        // only applies to non abstract classes
        if (e.ctx.classType.abstract) {
            return;
        }
        const initializer = e.ctx.initializer;
        if (!e.assert(initializer, e.ctx.fqn)) {
            return;
        }
        const expectedParams = new Array();
        expectedParams.push({
            name: 'scope',
            type: e.ctx.core.constructClass.fqn
        });
        expectedParams.push({
            name: 'id',
            type: 'string'
        });
        // it's okay for a construct not to have a "props" argument so we only
        // assert the "props" argument if there are more than two parameters
        if (initializer.parameters.length > 2) {
            expectedParams.push({
                name: 'props',
            });
        }
        e.assertSignature(initializer, {
            parameters: expectedParams
        });
    }
});
exports.constructLinter.add({
    code: 'props-struct-name',
    message: 'all constructs must have a props struct',
    eval: e => {
        if (!e.ctx.hasPropsArgument) {
            return;
        }
        // abstract classes are exempt
        if (e.ctx.classType.abstract) {
            return;
        }
        e.assert(e.ctx.propsType, e.ctx.interfaceFqn);
    }
});
exports.constructLinter.add({
    code: 'construct-ctor-props-type',
    message: 'construct "props" type should use the props struct %s',
    eval: e => {
        if (!e.ctx.initializer) {
            return;
        }
        if (e.ctx.initializer.parameters.length < 3) {
            return;
        }
        e.assert(e.ctx.initializer.parameters[2].type.type === e.ctx.propsType, e.ctx.fqn, e.ctx.propsFqn);
    }
});
exports.constructLinter.add({
    code: 'construct-ctor-props-optional',
    message: 'construct "props" must be optional since all props are optional',
    eval: e => {
        if (!e.ctx.propsType) {
            return;
        }
        if (!e.ctx.initializer) {
            return;
        }
        if (!e.ctx.hasPropsArgument) {
            return;
        }
        // this rule applies only if all properties are optional
        const allOptional = e.ctx.propsType.allProperties.every(p => p.optional);
        if (!allOptional) {
            return;
        }
        e.assert(e.ctx.initializer.parameters[2].optional, e.ctx.fqn);
    }
});
exports.constructLinter.add({
    code: 'construct-interface-extends-iconstruct',
    message: 'construct interface must extend core.IConstruct',
    eval: e => {
        if (!e.ctx.interfaceType) {
            return;
        }
        const interfaceBase = e.ctx.sys.findInterface(e.ctx.core.constructInterface.fqn);
        e.assert(e.ctx.interfaceType.extends(interfaceBase), e.ctx.interfaceType.fqn);
    }
});
exports.constructLinter.add({
    code: 'construct-base-is-private',
    message: 'prefer that the construct base class is private',
    warning: true,
    eval: e => {
        if (!e.ctx.interfaceType) {
            return;
        }
        const baseFqn = `${e.ctx.classType.fqn}Base`;
        e.assert(!e.ctx.sys.tryFindFqn(baseFqn), baseFqn);
    }
});
exports.constructLinter.add({
    code: 'props-no-unions',
    message: 'props must not use TypeScript unions',
    eval: e => {
        if (!e.ctx.propsType) {
            return;
        }
        if (!e.ctx.hasPropsArgument) {
            return;
        }
        // this rule does not apply to L1 constructs
        if (core_types_1.CoreTypes.isCfnResource(e.ctx.classType)) {
            return;
        }
        for (const property of e.ctx.propsType.ownProperties) {
            e.assert(!property.type.unionOfTypes, `${e.ctx.propsFqn}.${property.name}`);
        }
    }
});
exports.constructLinter.add({
    code: 'props-no-arn-refs',
    message: 'props must use strong types instead of attributes. props should not have "arn" suffix',
    eval: e => {
        if (!e.ctx.propsType) {
            return;
        }
        if (!e.ctx.hasPropsArgument) {
            return;
        }
        // this rule does not apply to L1 constructs
        if (core_types_1.CoreTypes.isCfnResource(e.ctx.classType)) {
            return;
        }
        for (const property of e.ctx.propsType.ownProperties) {
            e.assert(!property.name.toLowerCase().endsWith('arn'), `${e.ctx.propsFqn}.${property.name}`);
        }
    }
});
exports.constructLinter.add({
    code: 'props-no-tokens',
    message: 'props must not use the "Token" type',
    eval: e => {
        if (!e.ctx.propsType) {
            return;
        }
        if (!e.ctx.hasPropsArgument) {
            return;
        }
        // this rule does not apply to L1 constructs
        if (core_types_1.CoreTypes.isCfnResource(e.ctx.classType)) {
            return;
        }
        for (const property of e.ctx.propsType.allProperties) {
            const fqn = ConstructReflection.getFqnFromTypeRef(property.type);
            const found = (fqn && e.ctx.sys.tryFindFqn(fqn));
            if (found) {
                e.assert(!(fqn === e.ctx.core.tokenInterface.fqn), `${e.ctx.propsFqn}.${property.name}`);
            }
        }
    }
});
exports.constructLinter.add({
    code: 'props-no-cfn-types',
    message: 'props must not expose L1 types (types which start with "Cfn")',
    eval: e => {
        if (!e.ctx.propsType) {
            return;
        }
        if (!e.ctx.hasPropsArgument) {
            return;
        }
        // this rule does not apply to L1 constructs
        if (core_types_1.CoreTypes.isCfnResource(e.ctx.classType)) {
            return;
        }
        for (const property of e.ctx.propsType.ownProperties) {
            const fqn = ConstructReflection.getFqnFromTypeRef(property.type);
            const found = (fqn && e.ctx.sys.tryFindFqn(fqn));
            if (found) {
                e.assert(!found.name.toLowerCase().startsWith('cfn'), `${e.ctx.propsFqn}.${property.name}`);
            }
        }
    }
});
exports.constructLinter.add({
    code: 'props-no-any',
    message: 'props must not use Typescript "any" type',
    eval: e => {
        if (!e.ctx.propsType) {
            return;
        }
        if (!e.ctx.hasPropsArgument) {
            return;
        }
        // this rule does not apply to L1 constructs
        if (core_types_1.CoreTypes.isCfnResource(e.ctx.classType)) {
            return;
        }
        for (const property of e.ctx.propsType.ownProperties) {
            e.assert(!property.type.isAny, `${e.ctx.propsFqn}.${property.name}`);
        }
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29uc3RydWN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiY29uc3RydWN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQ0Esc0NBQXdFO0FBQ3hFLDZDQUF5QztBQUU1QixRQUFBLGVBQWUsR0FBRyxJQUFJLGVBQU0sQ0FBc0IsUUFBUSxDQUFDLEVBQUUsQ0FBQyxRQUFRLENBQUMsT0FBTztLQUN4RixNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxzQkFBUyxDQUFDLGdCQUFnQixDQUFDLENBQUMsQ0FBQyxDQUFDO0tBQzFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsRUFBRSxDQUFDLElBQUksbUJBQW1CLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBRXpELE1BQWEsbUJBQW1CO0lBOEI5QixZQUE0QixTQUE0QjtRQUE1QixjQUFTLEdBQVQsU0FBUyxDQUFtQjtRQUN0RCxJQUFJLENBQUMsR0FBRyxHQUFHLFNBQVMsQ0FBQyxHQUFHLENBQUM7UUFDekIsSUFBSSxDQUFDLEdBQUcsR0FBRyxTQUFTLENBQUMsTUFBTSxDQUFDO1FBQzVCLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxzQkFBUyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNwQyxJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ25FLElBQUksQ0FBQyxZQUFZLEdBQUcsR0FBRyxTQUFTLENBQUMsUUFBUSxDQUFDLElBQUksS0FBSyxTQUFTLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDcEUsSUFBSSxDQUFDLFFBQVEsR0FBRyxHQUFHLFNBQVMsQ0FBQyxRQUFRLENBQUMsSUFBSSxJQUFJLFNBQVMsQ0FBQyxJQUFJLE9BQU8sQ0FBQztRQUNwRSxJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFD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QyxHQUFHLENBQUMsZ0JBQWdCLEVBQUU7WUFBRSxPQUFPO1NBQUU7UUFFeEMsNENBQTRDO1FBQzVDLElBQUksc0JBQVMsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsRUFBRTtZQUFFLE9BQU87U0FBRTtRQUV6RCxLQUFLLE1BQU0sUUFBUSxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLGFBQWEsRUFBRTtZQUN0RCxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLFFBQVEsSUFBSSxRQUFRLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztTQUNwRTtJQUNILENBQUM7Q0FDRixDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyByZWZsZWN0IGZyb20gJ2pzaWktcmVmbGVjdCc7XG5pbXBvcnQgeyBMaW50ZXIsIE1ldGhvZFNpZ25hdHVyZVBhcmFtZXRlckV4cGVjdGF0aW9uIH0gZnJvbSAnLi4vbGludGVyJztcbmltcG9ydCB7IENvcmVUeXBlcyB9IGZyb20gJy4vY29yZS10eXBlcyc7XG5cbmV4cG9ydCBjb25zdCBjb25zdHJ1Y3RMaW50ZXIgPSBuZXcgTGludGVyPENvbnN0cnVjdFJlZmxlY3Rpb24+KGFzc2VtYmx5ID0+IGFzc2VtYmx5LmNsYXNzZXNcbiAgLmZpbHRlcih0ID0+IENvcmVUeXBlcy5pc0NvbnN0cnVjdENsYXNzKHQpKVxuICAubWFwKGNvbnN0cnVjdCA9PiBuZXcgQ29uc3RydWN0UmVmbGVjdGlvbihjb25zdHJ1Y3QpKSk7XG5cbmV4cG9ydCBjbGFzcyBDb25zdHJ1Y3RSZWZsZWN0aW9uIHtcblxuICBwdWJsaWMgc3RhdGljIGZpbmRBbGxDb25zdHJ1Y3RzKGFzc2VtYmx5OiByZWZsZWN0LkFzc2VtYmx5KSB7XG4gICAgcmV0dXJuIGFzc2VtYmx5LmNsYXNzZXNcbiAgICAgIC5maWx0ZXIoYyA9PiBDb3JlVHlwZXMuaXNDb25zdHJ1Y3RDbGFzcyhjKSlcbiAgICAgIC5tYXAoYyA9PiBuZXcgQ29uc3RydWN0UmVmbGVjdGlvbihjKSk7XG4gIH1cblxuICBwdWJsaWMgc3RhdGljIGdldEZxbkZyb21UeXBlUmVmKHR5cGVSZWY6IHJlZmxlY3QuVHlwZVJlZmVyZW5jZSkge1xuICAgIGlmICh0eXBlUmVmLmFycmF5T2ZUeXBlKSB7XG4gICAgICByZXR1cm4gdHlwZVJlZi5hcnJheU9mVHlwZS5mcW47XG4gICAgfSBlbHNlIGlmICh0eXBlUmVmLm1hcE9mVHlwZSkge1xuICAgICAgcmV0dXJuIHR5cGVSZWYubWFwT2ZUeXBlLmZxbjtcbiAgICB9XG5cbiAgICByZXR1cm4gdHlwZVJlZi5mcW47XG4gIH1cblxuICBwdWJsaWMgcmVhZG9ubHkgUk9PVF9DTEFTUzogcmVmbGVjdC5DbGFzc1R5cGU7IC8vIGNkay5Db25zdHJ1Y3RcblxuICBwdWJsaWMgcmVhZG9ubHkgZnFuOiBzdHJpbmc7XG4gIHB1YmxpYyByZWFkb25seSBpbnRlcmZhY2VGcW46IHN0cmluZztcbiAgcHVibGljIHJlYWRvbmx5IHByb3BzRnFuOiBzdHJpbmc7XG4gIHB1YmxpYyByZWFkb25seSBpbnRlcmZhY2VUeXBlPzogcmVmbGVjdC5JbnRlcmZhY2VUeXBlO1xuICBwdWJsaWMgcmVhZG9ubHkgcHJvcHNUeXBlPzogcmVmbGVjdC5JbnRlcmZhY2VUeXBlO1xuICBwdWJsaWMgcmVhZG9ubHkgaW5pdGlhbGl6ZXI/OiByZWZsZWN0LkluaXRpYWxpemVyO1xuICBwdWJsaWMgcmVhZG9ubHkgaGFzUHJvcHNBcmd1bWVudDogYm9vbGVhbjtcbiAgcHVibGljIHJlYWRvbmx5IHN5czogcmVmbGVjdC5UeXBlU3lzdGVtO1xuICBwdWJsaWMgcmVhZG9ubHkgY29yZTogQ29yZVR5cGVzO1xuXG4gIGNvbnN0cnVjdG9yKHB1YmxpYyByZWFkb25seSBjbGFzc1R5cGU6IHJlZmxlY3QuQ2xhc3NUeXBlKSB7XG4gICAgdGhpcy5mcW4gPSBjbGFzc1R5cGUuZnFuO1xuICAgIHRoaXMuc3lzID0gY2xhc3NUeXBlLnN5c3RlbTtcbiAgICB0aGlzLmNvcmUgPSBuZXcgQ29yZVR5cGVzKHRoaXMuc3lzKTtcbiAgICB0aGlzLlJPT1RfQ0xBU1MgPSB0aGlzLnN5cy5maW5kQ2xhc3ModGhpcy5jb3JlLmNvbnN0cnVjdENsYXNzLmZxbik7XG4gICAgdGhpcy5pbnRlcmZhY2VGcW4gPSBgJHtjbGFzc1R5cGUuYXNzZW1ibHkubmFtZX0uSSR7Y2xhc3NUeXBlLm5hbWV9YDtcbiAgICB0aGlzLnByb3BzRnFuID0gYCR7Y2xhc3NUeXBlLmFzc2VtYmx5Lm5hbWV9LiR7Y2xhc3NUeXBlLm5hbWV9UHJvcHNgO1xuICAgIHRoaXMuaW50ZXJmYWNlVHlwZSA9IHRoaXMudHJ5RmluZEludGVyZmFjZSgpO1xuICAgIHRoaXMucHJvcHNUeXBlID0gdGhpcy50cnlGaW5kUHJvcHMoKTtcbiAgICB0aGlzLmluaXRpYWxpemVyID0gY2xhc3NUeXBlLmluaXRpYWxpemVyO1xuICAgIHRoaXMuaGFzUHJvcHNBcmd1bWVudCA9IHRoaXMuaW5pdGlhbGl6ZXIgIT0gbnVsbCAmJiB0aGlzLmluaXRpYWxpemVyLnBhcmFtZXRlcnMubGVuZ3RoID49IDM7XG4gIH1cblxuICBwcml2YXRlIHRyeUZpbmRJbnRlcmZhY2UoKSB7XG4gICAgY29uc3Qgc3lzID0gdGhpcy5jbGFzc1R5cGUuc3lzdGVtO1xuICAgIGNvbnN0IGZvdW5kID0gc3lzLnRyeUZpbmRGcW4odGhpcy5pbnRlcmZhY2VGcW4pO1xuICAgIGlmICghZm91bmQpIHtcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuXG4gICAgaWYgKCFmb3VuZC5pc0ludGVyZmFjZVR5cGUoKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBFeHBlY3RpbmcgdHlwZSAke3RoaXMuaW50ZXJmYWNlRnFufSB0byBiZSBhbiBpbnRlcmZhY2VgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gZm91bmQ7XG4gIH1cblxuICBwcml2YXRlIHRyeUZpbmRQcm9wcygpIHtcbiAgICBjb25zdCBmb3VuZCA9IHRoaXMuc3lzLnRyeUZpbmRGcW4odGhpcy5wcm9wc0Zxbik7XG4gICAgaWYgKCFmb3VuZCkge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG5cbiAgICBpZiAoIWZvdW5kLmlzSW50ZXJmYWNlVHlwZSgpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEV4cGVjdGluZyBwcm9wcyBzdHJ1Y3QgJHt0aGlzLnByb3BzRnFufSB0byBiZSBhbiBpbnRlcmZhY2VgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gZm91bmQ7XG4gIH1cbn1cblxuY29uc3RydWN0TGludGVyLmFkZCh7XG4gIGNvZGU6ICdjb25zdHJ1Y3QtY3RvcicsXG4gIG1lc3NhZ2U6ICdzaWduYXR1cmUgb2YgYWxsIGNvbnN0cnVjdCBjb25zdHJ1Y3RvcnMgc2hvdWxkIGJlIFwic2NvcGUsIGlkLCBwcm9wc1wiJyxcbiAgZXZhbDogZSA9PiB7XG4gICAgLy8gb25seSBhcHBsaWVzIHRvIG5vbiBhYnN0cmFjdCBjbGFzc2VzXG4gICAgaWYgKGUuY3R4LmNsYXNzVHlwZS5hYnN0cmFjdCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IGluaXRpYWxpemVyID0gZS5jdHguaW5pdGlhbGl6ZXI7XG4gICAgaWYgKCFlLmFzc2VydChpbml0aWFsaXplciwgZS5jdHguZnFuKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IGV4cGVjdGVkUGFyYW1zID0gbmV3IEFycmF5PE1ldGhvZFNpZ25hdHVyZVBhcmFtZXRlckV4cGVjdGF0aW9uPigpO1xuXG4gICAgZXhwZWN0ZWRQYXJhbXMucHVzaCh7XG4gICAgICBuYW1lOiAnc2NvcGUnLFxuICAgICAgdHlwZTogZS5jdHguY29yZS5jb25zdHJ1Y3RDbGFzcy5mcW5cbiAgICB9KTtcblxuICAgIGV4cGVjdGVkUGFyYW1zLnB1c2goe1xuICAgICAgbmFtZTogJ2lkJyxcbiAgICAgIHR5cGU6ICdzdHJpbmcnXG4gICAgfSk7XG5cbiAgICAvLyBpdCdzIG9rYXkgZm9yIGEgY29uc3RydWN0IG5vdCB0byBoYXZlIGEgXCJwcm9wc1wiIGFyZ3VtZW50IHNvIHdlIG9ubHlcbiAgICAvLyBhc3NlcnQgdGhlIFwicHJvcHNcIiBhcmd1bWVudCBpZiB0aGVyZSBhcmUgbW9yZSB0aGFuIHR3byBwYXJhbWV0ZXJzXG4gICAgaWYgKGluaXRpYWxpemVyLnBhcmFtZXRlcnMubGVuZ3RoID4gMikge1xuICAgICAgZXhwZWN0ZWRQYXJhbXMucHVzaCh7XG4gICAgICAgIG5hbWU6ICdwcm9wcycsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBlLmFzc2VydFNpZ25hdHVyZShpbml0aWFsaXplciwge1xuICAgICAgcGFyYW1ldGVyczogZXhwZWN0ZWRQYXJhbXNcbiAgICB9KTtcbiAgfVxufSk7XG5cbmNvbnN0cnVjdExpbnRlci5hZGQoe1xuICBjb2RlOiAncHJvcHMtc3RydWN0LW5hbWUnLFxuICBtZXNzYWdlOiAnYWxsIGNvbnN0cnVjdHMgbXVzdCBoYXZlIGEgcHJvcHMgc3RydWN0JyxcbiAgZXZhbDogZSA9PiB7XG4gICAgaWYgKCFlLmN0eC5oYXNQcm9wc0FyZ3VtZW50KSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gYWJzdHJhY3QgY2xhc3NlcyBhcmUgZXhlbXB0XG4gICAgaWYgKGUuY3R4LmNsYXNzVHlwZS5hYnN0cmFjdCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGUuYXNzZXJ0KGUuY3R4LnByb3BzVHlwZSwgZS5jdHguaW50ZXJmYWNlRnFuKTtcbiAgfVxufSk7XG5cbmNvbnN0cnVjdExpbnRlci5hZGQoe1xuICBjb2RlOiAnY29uc3RydWN0LWN0b3ItcHJvcHMtdHlwZScsXG4gIG1lc3NhZ2U6ICdjb25zdHJ1Y3QgXCJwcm9wc1wiIHR5cGUgc2hvdWxkIHVzZSB0aGUgcHJvcHMgc3RydWN0ICVzJyxcbiAgZXZhbDogZSA9PiB7XG4gICAgaWYgKCFlLmN0eC5pbml0aWFsaXplcikgeyByZXR1cm47IH1cbiAgICBpZiAoZS5jdHguaW5pdGlhbGl6ZXIucGFyYW1ldGVycy5sZW5ndGggPCAzKSB7IHJldHVybjsgfVxuXG4gICAgZS5hc3NlcnQoXG4gICAgICBlLmN0eC5pbml0aWFsaXplci5wYXJhbWV0ZXJzWzJdLnR5cGUudHlwZSA9PT0gZS5jdHgucHJvcHNUeXBlLFxuICAgICAgZS5jdHguZnFuLFxuICAgICAgZS5jdHgucHJvcHNGcW4pO1xuICB9XG59KTtcblxuY29uc3RydWN0TGludGVyLmFkZCh7XG4gIGNvZGU6ICdjb25zdHJ1Y3QtY3Rvci1wcm9wcy1vcHRpb25hbCcsXG4gIG1lc3NhZ2U6ICdjb25zdHJ1Y3QgXCJwcm9wc1wiIG11c3QgYmUgb3B0aW9uYWwgc2luY2UgYWxsIHByb3BzIGFyZSBvcHRpb25hbCcsXG4gIGV2YWw6IGUgPT4ge1xuICAgIGlmICghZS5jdHgucHJvcHNUeXBlKSB7IHJldHVybjsgfVxuICAgIGlmICghZS5jdHguaW5pdGlhbGl6ZXIpIHsgcmV0dXJuOyB9XG4gICAgaWYgKCFlLmN0eC5oYXNQcm9wc0FyZ3VtZW50KSB7IHJldHVybjsgfVxuXG4gICAgLy8gdGhpcyBydWxlIGFwcGxpZXMgb25seSBpZiBhbGwgcHJvcGVydGllcyBhcmUgb3B0aW9uYWxcbiAgICBjb25zdCBhbGxPcHRpb25hbCA9IGUuY3R4LnByb3BzVHlwZS5hbGxQcm9wZXJ0aWVzLmV2ZXJ5KHAgPT4gcC5vcHRpb25hbCk7XG4gICAgaWYgKCFhbGxPcHRpb25hbCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGUuYXNzZXJ0KGUuY3R4LmluaXRpYWxpemVyLnBhcmFtZXRlcnNbMl0ub3B0aW9uYWwsIGUuY3R4LmZxbik7XG4gIH1cbn0pO1xuXG5jb25zdHJ1Y3RMaW50ZXIuYWRkKHtcbiAgY29kZTogJ2NvbnN0cnVjdC1pbnRlcmZhY2UtZXh0ZW5kcy1pY29uc3RydWN0JyxcbiAgbWVzc2FnZTogJ2NvbnN0cnVjdCBpbnRlcmZhY2UgbXVzdCBleHRlbmQgY29yZS5JQ29uc3RydWN0JyxcbiAgZXZhbDogZSA9PiB7XG4gICAgaWYgKCFlLmN0eC5pbnRlcmZhY2VUeXBlKSB7IHJldHVybjsgfVxuICAgIGNvbnN0IGludGVyZmFjZUJhc2UgPSBlLmN0eC5zeXMuZmluZEludGVyZmFjZShlLmN0eC5jb3JlLmNvbnN0cnVjdEludGVyZmFjZS5mcW4pO1xuICAgIGUuYXNzZXJ0KGUuY3R4LmludGVyZmFjZVR5cGUuZXh0ZW5kcyhpbnRlcmZhY2VCYXNlKSwgZS5jdHguaW50ZXJmYWNlVHlwZS5mcW4pO1xuICB9XG59KTtcblxuY29uc3RydWN0TGludGVyLmFkZCh7XG4gIGNvZGU6ICdjb25zdHJ1Y3QtYmFzZS1pcy1wcml2YXRlJyxcbiAgbWVzc2FnZTogJ3ByZWZlciB0aGF0IHRoZSBjb25zdHJ1Y3QgYmFzZSBjbGFzcyBpcyBwcml2YXRlJyxcbiAgd2FybmluZzogdHJ1ZSxcbiAgZXZhbDogZSA9PiB7XG4gICAgaWYgKCFlLmN0eC5pbnRlcmZhY2VUeXBlKSB7IHJldHVybjsgfVxuICAgIGNvbnN0IGJhc2VGcW4gPSBgJHtlLmN0eC5jbGFzc1R5cGUuZnFufUJhc2VgO1xuICAgIGUuYXNzZXJ0KCFlLmN0eC5zeXMudHJ5RmluZEZxbihiYXNlRnFuKSwgYmFzZUZxbik7XG4gIH1cbn0pO1xuXG5jb25zdHJ1Y3RMaW50ZXIuYWRkKHtcbiAgY29kZTogJ3Byb3BzLW5vLXVuaW9ucycsXG4gIG1lc3NhZ2U6ICdwcm9wcyBtdXN0IG5vdCB1c2UgVHlwZVNjcmlwdCB1bmlvbnMnLFxuICBldmFsOiBlID0+IHtcbiAgICBpZiAoIWUuY3R4LnByb3BzVHlwZSkgeyByZXR1cm47IH1cbiAgICBpZiAoIWUuY3R4Lmhhc1Byb3BzQXJndW1lbnQpIHsgcmV0dXJuOyB9XG5cbiAgICAvLyB0aGlzIHJ1bGUgZG9lcyBub3QgYXBwbHkgdG8gTDEgY29uc3RydWN0c1xuICAgIGlmIChDb3JlVHlwZXMuaXNDZm5SZXNvdXJjZShlLmN0eC5jbGFzc1R5cGUpKSB7IHJldHVybjsgfVxuXG4gICAgZm9yIChjb25zdCBwcm9wZXJ0eSBvZiBlLmN0eC5wcm9wc1R5cGUub3duUHJvcGVydGllcykge1xuICAgICAgZS5hc3NlcnQoIXByb3BlcnR5LnR5cGUudW5pb25PZlR5cGVzLCBgJHtlLmN0eC5wcm9wc0Zxbn0uJHtwcm9wZXJ0eS5uYW1lfWApO1xuICAgIH1cbiAgfVxufSk7XG5cbmNvbnN0cnVjdExpbnRlci5hZGQoe1xuICBjb2RlOiAncHJvcHMtbm8tYXJuLXJlZnMnLFxuICBtZXNzYWdlOiAncHJvcHMgbXVzdCB1c2Ugc3Ryb25nIHR5cGVzIGluc3RlYWQgb2YgYXR0cmlidXRlcy4gcHJvcHMgc2hvdWxkIG5vdCBoYXZlIFwiYXJuXCIgc3VmZml4JyxcbiAgZXZhbDogZSA9PiB7XG4gICAgaWYgKCFlLmN0eC5wcm9wc1R5cGUpIHsgcmV0dXJuOyB9XG4gICAgaWYgKCFlLmN0eC5oYXNQcm9wc0FyZ3VtZW50KSB7IHJldHVybjsgfVxuXG4gICAgLy8gdGhpcyBydWxlIGRvZXMgbm90IGFwcGx5IHRvIEwxIGNvbnN0cnVjdHNcbiAgICBpZiAoQ29yZVR5cGVzLmlzQ2ZuUmVzb3VyY2UoZS5jdHguY2xhc3NUeXBlKSkgeyByZXR1cm47IH1cblxuICAgIGZvciAoY29uc3QgcHJvcGVydHkgb2YgZS5jdHgucHJvcHNUeXBlLm93blByb3BlcnRpZXMpIHtcbiAgICAgIGUuYXNzZXJ0KCFwcm9wZXJ0eS5uYW1lLnRvTG93ZXJDYXNlKCkuZW5kc1dpdGgoJ2FybicpLCBgJHtlLmN0eC5wcm9wc0Zxbn0uJHtwcm9wZXJ0eS5uYW1lfWApO1xuICAgIH1cbiAgfVxufSk7XG5cbmNvbnN0cnVjdExpbnRlci5hZGQoe1xuICBjb2RlOiAncHJvcHMtbm8tdG9rZW5zJyxcbiAgbWVzc2FnZTogJ3Byb3BzIG11c3Qgbm90IHVzZSB0aGUgXCJUb2tlblwiIHR5cGUnLFxuICBldmFsOiBlID0+IHtcbiAgICBpZiAoIWUuY3R4LnByb3BzVHlwZSkgeyByZXR1cm47IH1cbiAgICBpZiAoIWUuY3R4Lmhhc1Byb3BzQXJndW1lbnQpIHsgcmV0dXJuOyB9XG5cbiAgICAvLyB0aGlzIHJ1bGUgZG9lcyBub3QgYXBwbHkgdG8gTDEgY29uc3RydWN0c1xuICAgIGlmIChDb3JlVHlwZXMuaXNDZm5SZXNvdXJjZShlLmN0eC5jbGFzc1R5cGUpKSB7IHJldHVybjsgfVxuXG4gICAgZm9yIChjb25zdCBwcm9wZXJ0eSBvZiBlLmN0eC5wcm9wc1R5cGUuYWxsUHJvcGVydGllcykge1xuICAgICAgY29uc3QgZnFuID0gQ29uc3RydWN0UmVmbGVjdGlvbi5nZXRGcW5Gcm9tVHlwZVJlZihwcm9wZXJ0eS50eXBlKTtcblxuICAgICAgY29uc3QgZm91bmQgPSAoZnFuICYmIGUuY3R4LnN5cy50cnlGaW5kRnFuKGZxbikpO1xuICAgICAgaWYgKGZvdW5kKSB7XG4gICAgICAgIGUuYXNzZXJ0KCEoZnFuID09PSBlLmN0eC5jb3JlLnRva2VuSW50ZXJmYWNlLmZxbiksIGAke2UuY3R4LnByb3BzRnFufS4ke3Byb3BlcnR5Lm5hbWV9YCk7XG4gICAgICB9XG4gICAgfVxuICB9XG59KTtcblxuY29uc3RydWN0TGludGVyLmFkZCh7XG4gIGNvZGU6ICdwcm9wcy1uby1jZm4tdHlwZXMnLFxuICBtZXNzYWdlOiAncHJvcHMgbXVzdCBub3QgZXhwb3NlIEwxIHR5cGVzICh0eXBlcyB3aGljaCBzdGFydCB3aXRoIFwiQ2ZuXCIpJyxcbiAgZXZhbDogZSA9PiB7XG4gICAgaWYgKCFlLmN0eC5wcm9wc1R5cGUpIHsgcmV0dXJuOyB9XG4gICAgaWYgKCFlLmN0eC5oYXNQcm9wc0FyZ3VtZW50KSB7IHJldHVybjsgfVxuXG4gICAgLy8gdGhpcyBydWxlIGRvZXMgbm90IGFwcGx5IHRvIEwxIGNvbnN0cnVjdHNcbiAgICBpZiAoQ29yZVR5cGVzLmlzQ2ZuUmVzb3VyY2UoZS5jdHguY2xhc3NUeXBlKSkgeyByZXR1cm47IH1cblxuICAgIGZvciAoY29uc3QgcHJvcGVydHkgb2YgZS5jdHgucHJvcHNUeXBlLm93blByb3BlcnRpZXMpIHtcbiAgICAgIGNvbnN0IGZxbiA9IENvbnN0cnVjdFJlZmxlY3Rpb24uZ2V0RnFuRnJvbVR5cGVSZWYocHJvcGVydHkudHlwZSk7XG5cbiAgICAgIGNvbnN0IGZvdW5kID0gKGZxbiAmJiBlLmN0eC5zeXMudHJ5RmluZEZxbihmcW4pKTtcbiAgICAgIGlmIChmb3VuZCkge1xuICAgICAgICBlLmFzc2VydCghZm91bmQubmFtZS50b0xvd2VyQ2FzZSgpLnN0YXJ0c1dpdGgoJ2NmbicpLCBgJHtlLmN0eC5wcm9wc0Zxbn0uJHtwcm9wZXJ0eS5uYW1lfWApO1xuICAgICAgfVxuICAgIH1cbiAgfVxufSk7XG5cbmNvbnN0cnVjdExpbnRlci5hZGQoe1xuICBjb2RlOiAncHJvcHMtbm8tYW55JyxcbiAgbWVzc2FnZTogJ3Byb3BzIG11c3Qgbm90IHVzZSBUeXBlc2NyaXB0IFwiYW55XCIgdHlwZScsXG4gIGV2YWw6IGUgPT4ge1xuICAgIGlmICghZS5jdHgucHJvcHNUeXBlKSB7IHJldHVybjsgfVxuICAgIGlmICghZS5jdHguaGFzUHJvcHNBcmd1bWVudCkgeyByZXR1cm47IH1cblxuICAgIC8vIHRoaXMgcnVsZSBkb2VzIG5vdCBhcHBseSB0byBMMSBjb25zdHJ1Y3RzXG4gICAgaWYgKENvcmVUeXBlcy5pc0NmblJlc291cmNlKGUuY3R4LmNsYXNzVHlwZSkpIHsgcmV0dXJuOyB9XG5cbiAgICBmb3IgKGNvbnN0IHByb3BlcnR5IG9mIGUuY3R4LnByb3BzVHlwZS5vd25Qcm9wZXJ0aWVzKSB7XG4gICAgZS5hc3NlcnQoIXByb3BlcnR5LnR5cGUuaXNBbnksIGAke2UuY3R4LnByb3BzRnFufS4ke3Byb3BlcnR5Lm5hbWV9YCk7XG4gICAgfVxuICB9XG59KTtcbiJdfQ==